dá»¯ liá»‡u dÃ¹ng tá»« táº­p mapillary vistas( 66 lá»›p): giá»›i thiá»‡u ngáº¯n vá» dataset nÃ y
Äáº·c Ä‘iá»ƒm Ä‘Æ°á»ng phá»‘ Viá»‡t Nam
Máº­t Ä‘á»™ giao thÃ´ng cao: Xe mÃ¡y, xe Ä‘áº¡p, ngÆ°á»i Ä‘i bá»™ xuáº¥t hiá»‡n dÃ y Ä‘áº·c.
Vá»‰a hÃ¨ phá»©c táº¡p: ThÆ°á»ng bá»‹ chiáº¿m dá»¥ng bá»Ÿi xe mÃ¡y, hÃ ng rong, hoáº·c khÃ´ng liÃªn tá»¥c.
Váº­t cáº£n phá»• biáº¿n: Cá»™t Ä‘iá»‡n, cÃ¢y cá»‘i, há»‘ ga khÃ´ng Ä‘áº­y náº¯p, xe Ä‘á»— sai quy Ä‘á»‹nh.
Biá»ƒn bÃ¡o giao thÃ´ng: Ãt Ä‘Æ°á»£c tuÃ¢n thá»§ nghiÃªm ngáº·t, nhÆ°ng váº«n cáº§n phÃ¡t hiá»‡n Ä‘á»ƒ Ä‘á»‹nh hÆ°á»›ng.
ÄÆ°á»ng Ä‘i an toÃ n: Vá»‰a hÃ¨, váº¡ch qua Ä‘Æ°á»ng lÃ  yáº¿u tá»‘ chÃ­nh Ä‘á»ƒ hÆ°á»›ng dáº«n ngÆ°á»i khiáº¿m thá»‹.
Dá»±a trÃªn Ä‘áº·c Ä‘iá»ƒm nÃ y, chÃºng ta sáº½ chá»n cÃ¡c lá»›p tá»« Mapillary Vistas sao cho phÃ¹ há»£p vá»›i bÃ i toÃ¡n vÃ  bá»‘i cáº£nh Viá»‡t Nam.
1. PhÃ¢n tÃ­ch file config.json cá»§a táº­p dá»¯ liá»‡u Ä‘Æ°á»£c chá»n Mapillary vistas
Sá»‘ lÆ°á»£ng lá»›p: CÃ³ 66 lá»›p Ä‘Æ°á»£c liá»‡t kÃª, bao gá»“m cÃ¡c nhÃ³m nhÆ° animal, construction, human, object, nature, void, v.v.
ThÃ´ng tin má»—i lá»›p:
name: TÃªn Ä‘áº§y Ä‘á»§ cá»§a lá»›p (vÃ­ dá»¥: object--vehicle--motorcycle).
readable: TÃªn dá»… Ä‘á»c (vÃ­ dá»¥: Motorcycle).
color: GiÃ¡ trá»‹ RGB tÆ°Æ¡ng á»©ng vá»›i lá»›p trong áº£nh máº·t náº¡ (mask).
instances: true náº¿u lá»›p Ä‘Æ°á»£c coi lÃ  Ä‘á»‘i tÆ°á»£ng riÃªng láº» (cÃ³ thá»ƒ dÃ¹ng bounding box), false náº¿u lÃ  vÃ¹ng khÃ´ng gian (thÆ°á»ng lÃ  ná»n hoáº·c bá» máº·t).
evaluate: true náº¿u lá»›p Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡, false náº¿u khÃ´ng (nhÆ° void--unlabeled).

sau Ä‘Ã³ thá»±c hiá»‡n xá»­ lÃ½ dá»¯ liá»‡u:
1. chá»n lá»›p:  Ä‘á»‘i chiáº¿u vá»›i file config.json cung cáº¥p sáºµn tá»« dá»¯ liá»‡u
Mapping class_id â†” class_name â†” class_color:
  ğŸ”¹ 1: Person                         | color: (220, 20, 60)
  ğŸ”¹ 10: Bicycle                       | color: (119, 11, 32)
  ğŸ”¹ 12: Car                           | color: (0, 0, 142)
  ğŸ”¹ 13: Motorcycle                    | color: (0, 0, 230)
  ğŸ”¹ 4: Vegetation                     | color: (107, 142, 35)
  ğŸ”¹ 3: Billboard                      | color: (220, 220, 220)
  ğŸ”¹ 6: Manhole                        | color: (100, 128, 160)
  ğŸ”¹ 9: Trash Can                      | color: (140, 140, 20)
  ğŸ”¹ 11: Barrier                       | color: (90, 120, 150)


2. Chuyá»ƒn Ä‘á»•i nhÃ£n dáº¡ng mask RGB vá» nhÃ£n theo format yolo
format yolo label: ?
code chuyá»ƒn Ä‘á»•i:
import json
import os
import cv2
import numpy as np
from scipy.ndimage import label
from pathlib import Path
from uuid import uuid4
from scipy.spatial.distance import cdist

# Äá»c file config
def load_config(config_path):
    with open(config_path, 'r') as f:
        config = json.load(f)
    return config['labels']

# Lá»c cÃ¡c lá»›p Ä‘Æ°á»£c chá»n
def filter_classes(labels, selected_classes):
    return [lbl for lbl in labels if lbl['readable'] in selected_classes]

# Táº¡o mapping tá»« mÃ u sáº¯c sang class_id
def create_color_to_class_mapping(labels, selected_classes):
    color_to_class = {}
    class_id = 0
    for lbl in labels:
        if lbl['readable'] in selected_classes:
            color = tuple(lbl['color'])
            color_to_class[color] = class_id
            class_id += 1
    return color_to_class

# Gá»™p cÃ¡c vÃ¹ng gáº§n nhau vÃ  táº¡o bounding box
def get_bounding_boxes(binary_mask, min_area=50, max_distance=50):
    # PhÃ¢n vÃ¹ng liÃªn káº¿t
    labeled_array, num_features = label(binary_mask)
    if num_features == 0:
        return []
    
    # LÆ°u trá»¯ thÃ´ng tin vÃ¹ng
    regions = []
    for i in range(1, num_features + 1):
        region = (labeled_array == i)
        if np.sum(region) < min_area:  # Bá» qua vÃ¹ng quÃ¡ nhá»
            continue
        y, x = np.where(region)
        x_min, x_max = x.min(), x.max()
        y_min, y_max = y.min(), y.max()
        regions.append((x_min, y_min, x_max, y_max))
    
    if not regions:
        return []
    
    # Gá»™p cÃ¡c vÃ¹ng gáº§n nhau
    merged_regions = []
    while regions:
        current = regions.pop(0)
        merged = [current]
        
        # TÃ­nh khoáº£ng cÃ¡ch tá»« vÃ¹ng hiá»‡n táº¡i Ä‘áº¿n cÃ¡c vÃ¹ng khÃ¡c
        i = 0
        while i < len(regions):
            other = regions[i]
            # TÃ­nh khoáº£ng cÃ¡ch giá»¯a hai bounding box
            box1 = np.array([[current[0], current[1]], [current[2], current[3]]])
            box2 = np.array([[other[0], other[1]], [other[2], other[3]]])
            distances = cdist(box1, box2, metric='euclidean')
            min_distance = distances.min()
            
            if min_distance < max_distance:
                # Gá»™p vÃ¹ng
                merged.append(regions.pop(i))
            else:
                i += 1
        
        # Táº¡o bounding box cho vÃ¹ng gá»™p
        x_min = min(r[0] for r in merged)
        y_min = min(r[1] for r in merged)
        x_max = max(r[2] for r in merged)
        y_max = max(r[3] for r in merged)
        merged_regions.append((x_min, y_min, x_max, y_max))
    
    return merged_regions

# Chuyá»ƒn Ä‘á»•i mask sang Ä‘á»‹nh dáº¡ng YOLO
def mask_to_yolo(mask_path, output_path, color_to_class, img_width, img_height):
    # Äá»c mask
    mask = cv2.imread(mask_path)
    if mask is None:
        print(f"KhÃ´ng thá»ƒ Ä‘á»c mask: {mask_path}")
        return
    
    mask_rgb = cv2.cvtColor(mask, cv2.COLOR_BGR2RGB)
    height, width = mask_rgb.shape[:2]
    
    # Táº¡o file YOLO
    yolo_lines = []
    
    # Duyá»‡t qua tá»«ng lá»›p (mÃ u sáº¯c)
    for color, class_id in color_to_class.items():
        # Táº¡o mask nhá»‹ phÃ¢n cho mÃ u hiá»‡n táº¡i
        binary_mask = np.all(mask_rgb == color, axis=2).astype(np.uint8)
        
        # Táº¡o bounding box cho cÃ¡c Ä‘á»‘i tÆ°á»£ng
        bboxes = get_bounding_boxes(binary_mask)
        
        for x_min, y_min, x_max, y_max in bboxes:
            # TÃ­nh toÃ¡n tá»a Ä‘á»™ YOLO
            x_center = (x_min + x_max) / 2 / width
            y_center = (y_min + y_max) / 2 / height
            box_width = (x_max - x_min) / width
            box_height = (y_max - y_min) / height
            
            # Äáº£m báº£o bounding box há»£p lá»‡
            if box_width > 0 and box_height > 0:
                yolo_lines.append(f"{class_id} {x_center:.6f} {y_center:.6f} {box_width:.6f} {box_height:.6f}")
    
    # Ghi file YOLO
    output_file = output_path / f"{Path(mask_path).stem}.txt"
    with open(output_file, 'w') as f:
        f.write('\n'.join(yolo_lines))

# HÃ m chÃ­nh Ä‘á»ƒ xá»­ lÃ½ toÃ n bá»™ thÆ° má»¥c
def convert_mapillary_to_yolo(config_path, mask_dir, output_dir, selected_classes):
    # Táº¡o thÆ° má»¥c Ä‘áº§u ra náº¿u chÆ°a tá»“n táº¡i
    output_dir = Path(output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # Äá»c config vÃ  lá»c lá»›p
    labels = load_config(config_path)
    filtered_labels = filter_classes(labels, selected_classes)
    color_to_class = create_color_to_class_mapping(filtered_labels, selected_classes)
    
    # Duyá»‡t qua táº¥t cáº£ file mask
    mask_dir = Path(mask_dir)
    for mask_path in mask_dir.glob("*.png"):  # Giáº£ sá»­ mask lÃ  file PNG
        print(f"Äang xá»­ lÃ½: {mask_path}")
        # Äá»c kÃ­ch thÆ°á»›c áº£nh tá»« mask
        mask = cv2.imread(str(mask_path))
        if mask is None:
            continue
        img_height, img_width = mask.shape[:2]
        mask_to_yolo(mask_path, output_dir, color_to_class, img_width, img_height)
    
    # Ghi file classes.txt
    with open(output_dir / 'classes.txt', 'w') as f:
        f.write('\n'.join(selected_classes))

# Danh sÃ¡ch 15 lá»›p Ä‘Æ°á»£c chá»n
SELECTED_CLASSES = [
    "Ground Animal", "Person", "Bench", "Billboard", "Fire Hydrant",
    "Mailbox", "Manhole", "Pothole", "Traffic Sign (Front)", "Trash Can", 
    "Bicycle", "Bus", "Car", "Motorcycle", "Other Vehicle", 
]

# Cháº¡y script
if __name__ == "__main__":
    CONFIG_PATH = "config.json"  # Thay báº±ng Ä‘Æ°á»ng dáº«n tá»›i file config
    MASK_DIR = "masks"  # Thay báº±ng Ä‘Æ°á»ng dáº«n tá»›i thÆ° má»¥c chá»©a mask
    OUTPUT_DIR = "output"  # Thay báº±ng Ä‘Æ°á»ng dáº«n tá»›i thÆ° má»¥c Ä‘áº§u ra
    
    convert_mapillary_to_yolo(CONFIG_PATH, MASK_DIR, OUTPUT_DIR, SELECTED_CLASSES)

giáº£i thÃ­ch logic quan trá»ng

3. Trá»±c quan hÃ³a dá»¯ liá»‡u Ä‘Ã£ táº¡o nhÃ£n 
tá»± chÃ¨n áº£nh

4. Thá»‘ng kÃª
    cÃ³ 20000 áº£nh vÃ  labels Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i
    Thá»‘ng kÃª sá»‘ sample má»—i lá»›p:
  ğŸ”¹ Lá»›p 0: 347 instance(s)             : 0.0961%
  ğŸ”¹ Lá»›p 1: 74868 instance(s)           : 20.735%
  ğŸ”¹ Lá»›p 2: 3337 instance(s)            : 0.924%
  ğŸ”¹ Lá»›p 3: 66598 instance(s)           : 18.447%
  ğŸ”¹ Lá»›p 4: 2000 instance(s)            : 0.554%
  ğŸ”¹ Lá»›p 5: 746 instance(s)             : 0.207%
  ğŸ”¹ Lá»›p 6: 10175 instance(s)           : 2.818%
  ğŸ”¹ Lá»›p 7: 596 instance(s)             : 0.165%
  ğŸ”¹ Lá»›p 8: 96428 instance(s)           : 26.703%
  ğŸ”¹ Lá»›p 9: 7745 instance(s)            : 2.145%
  ğŸ”¹ Lá»›p 10: 5960 instance(s)           : 1.650%
  ğŸ”¹ Lá»›p 11: 75326 instance(s)          : 20.861%
  ğŸ”¹ Lá»›p 12: 10370 instance(s)          : 2.873%
  ğŸ”¹ Lá»›p 13: 1612 instance(s)           : 0.446%
  ğŸ”¹ Lá»›p 14: 4749 instance(s)           : 1.315%

5. Chá»n ra cÃ¡c áº£nh cÃ³ chá»©a lá»›p hiáº¿m Ä‘á»ƒ giáº£m máº¥t cÃ¢n báº±ng dá»¯ liá»‡u, vÃ  giáº£m táº£i dá»¯ liá»‡u huáº¥n luyá»‡n
cÃ¡c lá»›p má»¥c tiÃªu gá»“m: 
  ğŸ”¹ 0: Ground Animal                  | sample: 347
  ğŸ”¹ 4: Fire Hydrant                   | sample: 2000
  ğŸ”¹ 5: Mailbox                        | sample: 746
  ğŸ”¹ 7: Pothole                        | sample: 596 
  ğŸ”¹ 13: Motorcycle                    | sample: 1612

code chá»n file:

import os
import shutil

label_dir = "out_labels"
image_dir = "out_images"

selected_label_dir = "labels"
selected_image_dir = "images"

target_classes = {0, 4, 5, 7, 13}

os.makedirs(selected_label_dir, exist_ok=True)
os.makedirs(selected_image_dir, exist_ok=True)

error_files = []
selected_count = 0

for label_file in os.listdir(label_dir):
    if not label_file.endswith(".txt"):
        continue

    label_path = os.path.join(label_dir, label_file)
    found = False

    try:
        with open(label_path, "r") as f:
            lines = f.readlines()
            for line in lines:
                parts = line.strip().split()
                if not parts:
                    continue
                try:
                    class_id = int(parts[0])
                    if class_id in target_classes:
                        found = True
                        break
                except ValueError:
                    continue
    except Exception as e:
        error_files.append((label_file, str(e)))
        continue

    if found:
        # Copy label
        shutil.copy(label_path, os.path.join(selected_label_dir, label_file))

        # Copy image náº¿u tá»“n táº¡i
        base_name = os.path.splitext(label_file)[0]
        for ext in ['.jpg', '.png', '.jpeg']:
            image_path = os.path.join(image_dir, base_name + ext)
            if os.path.exists(image_path):
                shutil.copy(image_path, os.path.join(selected_image_dir, base_name + ext))
                break
        selected_count += 1

# Káº¿t quáº£
print(f"\nâœ… ÄÃ£ chá»n {selected_count} file há»£p lá»‡.")

if error_files:
    print(f"\nâš ï¸ CÃ³ {len(error_files)} file bá»‹ lá»—i format:")
    for filename, err in error_files:
        print(f"  - {filename}: {err}")




Code váº½ biá»ƒu Ä‘á»“ thá»‘ng kÃª táº¡i Ä‘Ã¢y: 

6. Chia dá»¯ liá»‡u train - val
chia dá»¯ liá»‡u 80% cho táº­p train( 10494 áº£nh), 20% val(2000 áº£nh), dá»¯ liá»‡u cÃ³ cáº¥u trÃºc nhÆ° sau (chÃ¨n áº£nh cáº¥u trÃºc thÆ° má»¥c)
file data yaml( chÃ¨n áº£nh file data yaml)

